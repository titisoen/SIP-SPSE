NARNO_MENANG => Ponorogo per 27-02-2021 = 1419 
	
	-- TABEL VIEW narno_menang 02 --

CREATE OR REPLACE VIEW sip.narno_menang AS 
SELECT DISTINCT lls.lls_id,
ang.sbd_id AS sbd_ket,
CASE
WHEN lls.mtd_pemilihan = 0::numeric THEN 'e-Lelang Umum'::text
WHEN lls.mtd_pemilihan = 1::numeric THEN 'e-Lelang Sederhana'::text
WHEN lls.mtd_pemilihan = 2::numeric THEN 'e-Lelang Pemilihan Langsung'::text
WHEN lls.mtd_pemilihan = 3::numeric THEN 'e-Seleksi Umum'::text
WHEN lls.mtd_pemilihan = 4::numeric THEN 'e-Seleksi Sederhana'::text
WHEN lls.mtd_pemilihan = 9::numeric THEN 'e-Lelang Cepat'::text
WHEN lls.mtd_pemilihan = 15::numeric THEN 'Tender'::text
WHEN lls.mtd_pemilihan = 16::numeric THEN 'Seleksi'::text
ELSE 'Belum Kategori'::text
END AS metode,
lls.mtd_pemilihan,
CASE
WHEN pkt.kgr_id = 0::numeric THEN 'Pengadaan Barang'::text
WHEN pkt.kgr_id = 1::numeric THEN 'Jasa Konsultansi'::text
WHEN pkt.kgr_id = 2::numeric THEN 'Pekerjaan Konstruksi'::text
WHEN pkt.kgr_id = 3::numeric THEN 'Jasa Lainnya'::text
ELSE 'Jasa Konsultansi Perorangan'::text
END AS kategori,
pkt.kgr_id,
date_part('year'::text, pkt.pkt_tgl_buat) AS tahun,
date_part('month'::text, pkt.pkt_tgl_buat) AS bulan,
ang.ang_tahun,
rkn.rkn_nama,
rkn.rkn_npwp,
pst.psr_harga,
kbp.kbp_id,
kbp.kbp_nama,
prp.prp_id,
prp.prp_nama,
pkt.pkt_pagu,
pkt.pkt_hps,
agc.agc_id,
pkt.pkt_flag,
nev.nev_harga,
CASE
WHEN nev.nev_harga_terkoreksi = 0::numeric THEN pst.psr_harga
WHEN nev.nev_harga = 0::numeric THEN pst.psr_harga_terkoreksi
WHEN pst.psr_harga_terkoreksi > nev.nev_harga THEN nev.nev_harga
WHEN nev.nev_harga = 0::numeric THEN pst.psr_harga
WHEN pst.psr_harga > nev.nev_harga THEN nev.nev_harga
WHEN pst.psr_harga_terkoreksi > pst.psr_harga THEN pst.psr_harga_terkoreksi
WHEN pst.psr_harga_terkoreksi = pst.psr_harga THEN pst.psr_harga
WHEN pst.psr_harga_terkoreksi = 0::numeric OR nev.nev_harga = 0::numeric THEN pst.psr_harga
WHEN pst.psr_harga = nev.nev_harga_terkoreksi THEN nev.nev_harga_terkoreksi
WHEN nev.nev_harga_terkoreksi = 0::numeric THEN nev.nev_harga
ELSE nev.nev_harga
END AS harga_terkoreksi
FROM public.lelang_seleksi lls,
public.paket pkt,
public.evaluasi eva,
public.nilai_evaluasi nev,
public.peserta pst,
public.rekanan rkn,
public.panitia pnt,
public.satuan_kerja stk,
public.paket_anggaran pa,
public.anggaran ang,
public.kabupaten kbp,
public.propinsi prp,
public.agency agc
WHERE pnt.pnt_id = pkt.pnt_id 
AND agc.agc_id = pnt.agc_id 
AND date_part('year'::text, lls.lls_tgl_setuju) > 0::double precision 
AND kbp.prp_id = prp.prp_id 
AND rkn.kbp_id = kbp.kbp_id 
AND pa.pkt_id = pkt.pkt_id 
AND pa.ang_id = ang.ang_id 
AND lls.pkt_id = pkt.pkt_id 
AND eva.lls_id = lls.lls_id 
AND ang.stk_id = stk.stk_id 
AND nev.eva_id = eva.eva_id 
AND pst.psr_id = nev.psr_id 
AND pst.rkn_id = rkn.rkn_id 
AND (eva.eva_id IN ( SELECT evaluasi_1.eva_id
   FROM public.evaluasi evaluasi_1
   WHERE ((evaluasi_1.lls_id, evaluasi_1.eva_versi) IN ( SELECT evaluasi_2.lls_id,
    max(evaluasi_2.eva_versi) AS max
    FROM public.evaluasi evaluasi_2
    GROUP BY evaluasi_2.lls_id)) AND evaluasi_1.eva_jenis = 4::numeric
   ORDER BY evaluasi_1.lls_id)) AND eva.eva_jenis = 4::numeric AND lls.lls_status = 1::numeric AND nev.nev_lulus = 1::numeric
ORDER BY lls.lls_id DESC;

ALTER TABLE sip.narno_menang OWNER TO epns;
